# Chet.QuartzNet.UI 通知功能使用指南

## 1. 功能概述

QuartzNet.UI 支持使用 PushPlus 服务发送任务执行和调度器异常通知，替代了传统的邮件通知方式。PushPlus 是一个集成了多种推送渠道的通知服务，支持微信、企业微信、钉钉、邮件、短信等多种推送方式。

![通知配置页面](images/screenshots/notification-config.png)

![通知历史页面](images/screenshots/notification-history.png)

![通知模板设计](images/design/notification-template-design.jpg)

![通知流程图](images/design/notification-flow-chart.jpg)

### 1.1 通知类型

- **作业执行通知**：当定时任务执行成功或失败时发送
- **调度器异常通知**：当调度器发生异常时发送

### 1.2 通知模板

系统支持三种通知模板格式，可根据需要自由选择：

- **HTML模板**：美观的富文本格式，支持表格、样式等
- **Markdown模板**：简洁的标记语言格式，适合技术人员阅读
- **纯文本模板**：简单的文本格式，兼容性最好

## 2. PushPlus 注册与配置

### 2.1 注册 PushPlus 账号

1. 访问 [PushPlus 官网](https://www.pushplus.plus/)
2. 使用微信扫码登录
3. 在个人中心获取 **Token**，用于系统配置

### 2.2 获取 PushPlus Token

1. 登录 PushPlus 后，点击右上角头像
2. 进入「个人中心」
3. 在「Token」栏获取你的专属 Token
4. 复制该 Token，用于系统配置

## 3. 系统配置

### 3.1 打开通知配置页面

1. 登录 QuartzNet.UI 系统
2. 进入「通知管理」页面
3. 点击左上角「通知配置」按钮

### 3.2 配置 PushPlus 参数

在弹出的配置对话框中，填写以下信息：

| 配置项 | 说明 | 示例值 |
|-------|------|--------|
| 启用通知 | 开关控制通知功能的启用与禁用 | 开启 |
| Token | PushPlus 个人中心获取的 Token | abcdef123456... |
| 推送渠道 | 选择通知推送的渠道 | wechat |
| 消息模板 | 选择通知内容的模板格式 | markdown |
| 主题 | 通知主题（可选） | Quartz 通知 |

### 3.3 配置通知策略

| 策略项 | 说明 | 默认值 |
|-------|------|--------|
| 作业成功时发送 | 任务执行成功时是否发送通知 | 关闭 |
| 作业失败时发送 | 任务执行失败时是否发送通知 | 开启 |
| 调度器异常时发送 | 调度器发生异常时是否发送通知 | 开启 |

## 4. 通知内容模板

### 4.1 HTML 模板

HTML 模板采用 GitHub 风格设计，包含以下内容：

- 醒目的状态标识（成功/失败/异常）
- 清晰的信息表格
- 美观的颜色区分
- 完整的执行详情

#### 作业成功通知示例

```html
<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; color: #24292f; max-width: 720px; margin: 0 auto; padding: 20px;">
    <div style="background-color: #ffffff; border: 1px solid #e1e4e8; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
        <div style="background-color: #f0fff4; border-bottom: 1px solid #e1e4e8; padding: 16px 20px;">
            <h1 style="margin: 0; font-size: 20px; font-weight: 600; color: #2da44e;">✅ 作业执行成功: 示例任务</h1>
        </div>
        <!-- 作业信息表格 -->
        <!-- 底部信息 -->
    </div>
</div>
```

### 4.2 Markdown 模板

Markdown 模板简洁明了，适合技术人员阅读：

#### 作业失败通知示例

```markdown
# ❌ 作业执行失败: 示例任务

## 作业信息

| 项目 | 内容 |
|------|------|
| 作业名称 | 示例任务 |
| 作业分组 | default |
| 执行状态 | ❌ 失败 |
| 执行时间 | 2025-12-08 22:30:00 |
| 执行耗时 | 1500 毫秒 |
| 消息 | 任务执行失败 |
| 错误信息 | System.Exception: 执行过程中发生错误 |

---
此消息由 Chet.QuartzNET.UI 调度系统自动发送，请勿回复。
```

### 4.3 纯文本模板

纯文本模板简单直接，兼容性最好：

#### 调度器异常通知示例

```
调度器异常

异常时间: 2025-12-08 22:35:00
异常类型: System.InvalidOperationException
异常消息: 调度器初始化失败
堆栈跟踪:    在 Quartz.Impl.StdSchedulerFactory.Instantiate()
   在 QuartzNet.UI.Services.QuartzJobService.StartAsync(CancellationToken cancellationToken)

---
此消息由 Chet.QuartzNET.UI 调度系统自动发送，请勿回复。
```

## 5. 测试通知

配置完成后，建议发送一条测试通知验证配置是否正确：

1. 在通知管理页面点击「发送测试通知」按钮
2. 检查是否收到测试通知
3. 如未收到，检查配置是否正确，特别是 Token 是否有效

## 6. 通知历史管理

### 6.1 查看通知历史

在「通知管理」页面，可以查看所有通知记录：

- 通知标题：显示通知类型和相关作业
- 触发来源：显示触发通知的作业或调度器
- 状态：显示通知发送状态（待发送/发送成功/发送失败）
- 创建时间：通知创建时间
- 发送时间：通知实际发送时间
- 耗时：通知发送耗时

### 6.2 筛选与搜索

- **状态筛选**：可按通知状态筛选（待发送/发送成功/发送失败）
- **来源搜索**：可按触发来源搜索特定通知

### 6.3 删除通知

- **单个删除**：点击每条通知后的「操作」按钮，选择「删除」
- **批量清空**：点击「清空」按钮，清空所有通知记录

## 7. 常见问题排查

### 7.1 测试通知发送失败

- 检查 PushPlus Token 是否正确
- 检查网络连接是否正常
- 检查推送渠道是否支持
- 查看系统日志获取详细错误信息

### 7.2 作业执行时未收到通知

- 检查通知功能是否已启用
- 检查对应通知策略是否已开启
- 检查作业执行状态是否符合通知条件
- 查看通知历史，确认通知是否已创建

### 7.3 通知内容格式不符合预期

- 检查消息模板配置是否正确
- 确认选择了合适的推送渠道，不同渠道对模板支持程度不同

## 8. 最佳实践

1. **开启关键通知**：建议开启「作业失败时发送」和「调度器异常时发送」通知
2. **选择合适模板**：根据推送渠道选择合适的模板，微信渠道推荐使用 HTML 或 Markdown
3. **定期清理通知**：定期清理通知历史，保持系统性能
4. **测试配置**：每次修改配置后，发送测试通知验证
5. **关注通知状态**：定期查看通知历史，确保通知正常发送

## 9. 版本更新

- **v1.0.0**：初始版本，支持 PushPlus 通知
- **v1.1.0**：优化通知模板，支持多种格式
- **v1.2.0**：增强通知历史管理功能

## 10. 联系与支持

如遇到使用问题，可通过以下方式获取支持：

- 查看系统日志获取详细错误信息
- 检查 PushPlus 官网文档
- 联系系统管理员

---

**更新时间**：2025-12-08  
**版本**：v1.2.0