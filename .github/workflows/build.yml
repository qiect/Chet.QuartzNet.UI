name: Build and Publish NuGet Packages

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'NuGet Package Version'
        required: true
        default: '1.0.0'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      # 1. 代码检查与依赖安装
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 2. 前端项目构建
      - name: Install frontend dependencies (root)
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm install --no-frozen-lockfile

      - name: Generate stubs for workspace packages
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm -r run stub --if-present

      - name: Build frontend project
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm run build:antd

      # 3. NuGet 包版本管理
      - name: Extract version from tag or input
        id: extract-version
        run: |
          # 从标签或输入获取版本号
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update nuspec version
        run: |
          # 更新根目录下的nuspec文件
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/" ./Chet.QuartzNet.UI.nuspec

      # 4. 主包打包
      - name: Build main package
        run: dotnet build src/Chet.QuartzNet.UI/Chet.QuartzNet.UI.csproj --configuration Release -p:PackageVersion=$VERSION

      - name: Pack main package
        run: dotnet pack src/Chet.QuartzNet.UI/Chet.QuartzNet.UI.csproj --configuration Release --no-build --output ./artifacts -p:PackageVersion=$VERSION

      # 5. 数据库存储包打包
      - name: Build MySQL package
        run: dotnet build src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.csproj --configuration Release -p:PackageVersion=$VERSION
      - name: Pack MySQL package
        run: dotnet pack src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.csproj --configuration Release --output ./artifacts -p:PackageVersion=$VERSION
      
      - name: Build PostgreSQL package
        run: dotnet build src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.csproj --configuration Release -p:PackageVersion=$VERSION
      - name: Pack PostgreSQL package
        run: dotnet pack src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.csproj --configuration Release --output ./artifacts -p:PackageVersion=$VERSION
      
      - name: Build SQLite package
        run: dotnet build src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.csproj --configuration Release -p:PackageVersion=$VERSION
      - name: Pack SQLite package
        run: dotnet pack src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.csproj --configuration Release --output ./artifacts -p:PackageVersion=$VERSION
      
      - name: Build SqlServer package
        run: dotnet build src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.csproj --configuration Release -p:PackageVersion=$VERSION
      - name: Pack SqlServer package
        run: dotnet pack src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.csproj --configuration Release --output ./artifacts -p:PackageVersion=$VERSION

      # 6. NuGet 包发布
      - name: Publish NuGet packages (Trusted Publishing)
        run: dotnet nuget push ./artifacts/*.nupkg --source https://api.nuget.org/v3/index.json --api-key az --skip-duplicate
