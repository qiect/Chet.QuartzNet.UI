name: Build and Publish NuGet Packages

on:
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      version:
        description: 'NuGet Package Version'
        required: true
        default: '1.0.0'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      # 1. 代码检查与依赖安装
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 2. 前端项目构建
      - name: Install frontend dependencies (root)
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm install --no-frozen-lockfile

      - name: Generate stubs for workspace packages
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm -r run stub --if-present

      - name: Build frontend project
        working-directory: src/Chet.QuartzNet.Web
        run: pnpm run build:antd

      # 3. NuGet 包版本管理
      - name: Extract version and release notes
        id: extract-version
        run: |
          # 从 release 事件或输入获取版本号
          if [[ ${{ github.event_name }} == "release" ]]; then
            VERSION=${{ github.event.release.tag_name }}
            RELEASE_NOTES="${{ github.event.release.body }}"
          else
            VERSION=${{ github.event.inputs.version }}
            RELEASE_NOTES=""
          fi
          
          # 处理换行符，确保能正确传递给 dotnet 命令
          RELEASE_NOTES="${RELEASE_NOTES//$'\n'/\\n}"
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_ENV

      # 3.1 Update nuspec file version
      - name: Update nuspec version and release notes
        run: |
          # 移除版本号中的 v 前缀（如果存在）
          VERSION=${VERSION#v}
          
          # 使用 sed 命令更新 nuspec 文件中的版本号
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/g" Chet.QuartzNet.UI.nuspec
          
          # 使用 sed 命令更新 nuspec 文件中的 releaseNotes
          if [ -z "$RELEASE_NOTES" ]; then
            # 如果没有发布说明，保持空元素
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes><\/releaseNotes>/g" Chet.QuartzNet.UI.nuspec
          else
            # 否则更新为实际的发布说明，需要先处理换行符
            ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g')
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes>$ESCAPED_NOTES<\/releaseNotes>/g" Chet.QuartzNet.UI.nuspec
          fi
          
          # 验证更新结果
          grep -A 3 "<id>Chet.QuartzNet.UI<\/id>" Chet.QuartzNet.UI.nuspec

      # 3.2 Update database storage packages nuspec files
      - name: Update database storage packages nuspec version and release notes
        run: |
          # 移除版本号中的 v 前缀（如果存在）
          VERSION=${VERSION#v}
          
          # 更新MySQL包nuspec
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/g" src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.nuspec
          if [ -z "$RELEASE_NOTES" ]; then
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes><\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.nuspec
          else
            ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g')
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes>$ESCAPED_NOTES<\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.nuspec
          fi
          
          # 更新PostgreSQL包nuspec
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/g" src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.nuspec
          if [ -z "$RELEASE_NOTES" ]; then
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes><\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.nuspec
          else
            ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g')
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes>$ESCAPED_NOTES<\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.nuspec
          fi
          
          # 更新SQLite包nuspec
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/g" src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.nuspec
          if [ -z "$RELEASE_NOTES" ]; then
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes><\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.nuspec
          else
            ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g')
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes>$ESCAPED_NOTES<\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.nuspec
          fi
          
          # 更新SqlServer包nuspec
          sed -i "s/<version>.*<\/version>/<version>$VERSION<\/version>/g" src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.nuspec
          if [ -z "$RELEASE_NOTES" ]; then
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes><\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.nuspec
          else
            ESCAPED_NOTES=$(echo "$RELEASE_NOTES" | sed 's/"/\\"/g')
            sed -i "s/<releaseNotes>.*<\/releaseNotes>/<releaseNotes>$ESCAPED_NOTES<\/releaseNotes>/g" src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.nuspec
          fi

      # 4. 主包打包
      - name: Build main package
        run: dotnet build src/Chet.QuartzNet.UI/Chet.QuartzNet.UI.csproj --configuration Release -p:PackageVersion=$VERSION

      - name: Pack main package
        run: dotnet pack src/Chet.QuartzNet.UI/Chet.QuartzNet.UI.csproj --configuration Release --no-build --output ./artifacts

      # 5. 数据库存储包打包
      - name: Build MySQL package
        run: dotnet build src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.csproj --configuration Release
      - name: Pack MySQL package
        run: dotnet pack src/Chet.QuartzNet.EFCore.MySql/Chet.QuartzNet.EFCore.MySQL.csproj --configuration Release --output ./artifacts
      
      - name: Build PostgreSQL package
        run: dotnet build src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.csproj --configuration Release
      - name: Pack PostgreSQL package
        run: dotnet pack src/Chet.QuartzNet.EFCore.PostgreSql/Chet.QuartzNet.EFCore.PostgreSQL.csproj --configuration Release --output ./artifacts
      
      - name: Build SQLite package
        run: dotnet build src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.csproj --configuration Release
      - name: Pack SQLite package
        run: dotnet pack src/Chet.QuartzNet.EFCore.SQLite/Chet.QuartzNet.EFCore.SQLite.csproj --configuration Release --output ./artifacts
      
      - name: Build SqlServer package
        run: dotnet build src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.csproj --configuration Release
      - name: Pack SqlServer package
        run: dotnet pack src/Chet.QuartzNet.EFCore.SqlServer/Chet.QuartzNet.EFCore.SqlServer.csproj --configuration Release --output ./artifacts

      # 6. NuGet 包发布
      - name: Publish NuGet packages (API Key)
        run: dotnet nuget push ./artifacts/*.nupkg --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }} --skip-duplicate
